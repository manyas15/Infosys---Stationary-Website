<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stationery App - Delete Product</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="background-animation"></div>
  
  <header class="topbar">
    <div class="brand">
      <i class="fas fa-store"></i>
      Stationery Store
    </div>
    <div class="spacer"></div>
    <div id="userBox" class="user-info"></div>
    <button id="logoutBtn" class="danger">
      <i class="fas fa-sign-out-alt"></i>
      Logout
    </button>
  </header>

  <main class="container">
    <div class="page-header">
      <h1>
        <i class="fas fa-trash-alt"></i>
        Delete Product
      </h1>
      <p>Select a product to delete from your inventory</p>
    </div>

    <div class="delete-section">
      <div class="card">
        <div class="warning-banner">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Warning: This action cannot be undone!</span>
        </div>
        
        <div class="search-section">
          <h3>
            <i class="fas fa-search"></i>
            Find Product to Delete
          </h3>
          <form id="findForm" class="search-form">
            <div class="form-group">
              <label for="id">
                <i class="fas fa-key"></i>
                Product ID
              </label>
              <input type="text" id="id" required placeholder="Enter product ID" />
            </div>
            <button type="submit" class="search-btn">
              <i class="fas fa-search"></i>
              Find Product
            </button>
          </form>
        </div>

        <div id="productPreview" class="product-preview-section" style="display:none;">
          <h3>
            <i class="fas fa-eye"></i>
            Product to Delete
          </h3>
          <div id="preview" class="product-preview"></div>
          <div class="delete-actions">
            <button id="confirmDelete" class="delete-btn">
              <i class="fas fa-trash-alt"></i>
              Confirm Delete
            </button>
            <button id="cancelDelete" class="cancel-btn">
              <i class="fas fa-times"></i>
              Cancel
            </button>
          </div>
        </div>
        
        <div id="msg" class="msg"></div>
      </div>
    </div>

    <div class="products-list-section">
      <div class="card">
        <h3>
          <i class="fas fa-list"></i>
          All Products
          <span id="itemCount" class="item-count">0 products</span>
        </h3>
        <div id="productsList" class="products-list">
          <div class="loading">Loading products...</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>
          <i class="fas fa-exclamation-triangle"></i>
          Confirm Deletion
        </h3>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this product?</p>
        <div id="modalPreview" class="modal-preview"></div>
        <p class="warning-text">This action cannot be undone!</p>
      </div>
      <div class="modal-actions">
        <button id="finalConfirm" class="delete-btn">
          <i class="fas fa-trash-alt"></i>
          Yes, Delete
        </button>
        <button id="modalCancel" class="cancel-btn">
          <i class="fas fa-times"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script>
    guardAuth();
    const user = getCurrentUser();
    document.getElementById('userBox').innerHTML = user ? 
      `<i class="fas fa-user"></i> Welcome, ${user.name}` : '';
    document.getElementById('logoutBtn').onclick = () => { logout(); location.href = 'index.html'; };

    const msg = document.getElementById('msg');
    const productPreview = document.getElementById('productPreview');
    const confirmModal = document.getElementById('confirmModal');
    let currentProduct = null;

    // Load all products
    async function loadProducts() {
      try {
        const data = await apiGet('/api/items');
        const productsList = document.getElementById('productsList');
        const countEl = document.getElementById('itemCount');
        
        countEl.textContent = `${data.items.length} products`;
        
        if (data.items.length === 0) {
          productsList.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>No products found</p></div>';
          return;
        }
        
        productsList.innerHTML = data.items.map(item => `
          <div class="product-item delete-item" onclick="selectProduct('${item.id}')">
            <div class="product-image">
              ${item.image ? `<img src="${item.image}" alt="${item.name}" onerror="this.style.display='none'">` : '<i class="fas fa-image"></i>'}
            </div>
            <div class="product-info">
              <h4>${item.name}</h4>
              <p class="product-id">ID: ${item.id}</p>
              <p class="product-details">${item.details || 'No details available'}</p>
              <div class="product-meta">
                <span class="category"><i class="fas fa-tag"></i> ${item.category}</span>
                <span class="quantity"><i class="fas fa-boxes"></i> ${item.quantity}</span>
                <span class="price"><i class="fas fa-rupee-sign"></i> ${item.price}</span>
              </div>
            </div>
            <div class="delete-icon">
              <i class="fas fa-trash-alt"></i>
            </div>
          </div>
        `).join('');
      } catch (error) {
        document.getElementById('productsList').innerHTML = '<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading products</p></div>';
      }
    }

    // Select product from list
    function selectProduct(id) {
      document.getElementById('id').value = id;
      document.getElementById('findForm').dispatchEvent(new Event('submit'));
    }

    // Find product form
    document.getElementById('findForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.className = 'msg';
      productPreview.style.display = 'none';
      
      const id = document.getElementById('id').value.trim();
      if (!id) {
        msg.textContent = 'Please enter a product ID';
        msg.className = 'msg error';
        return;
      }
      
      try {
        msg.textContent = 'Loading product...';
        msg.className = 'msg info';
        
        const res = await apiGet('/api/items/' + encodeURIComponent(id));
        currentProduct = res.item;
        
        // Show product preview
        const preview = document.getElementById('preview');
        preview.innerHTML = `
          <div class="preview-item">
            <div class="preview-image">
              ${currentProduct.image ? `<img src="${currentProduct.image}" alt="${currentProduct.name}" onerror="this.style.display='none'">` : '<i class="fas fa-image"></i>'}
            </div>
            <div class="preview-content">
              <h4>${currentProduct.name}</h4>
              <p class="preview-details">${currentProduct.details || 'No details available'}</p>
              <div class="preview-meta">
                <span class="preview-category"><i class="fas fa-tag"></i> ${currentProduct.category}</span>
                <span class="preview-quantity"><i class="fas fa-boxes"></i> ${currentProduct.quantity}</span>
                <span class="preview-price"><i class="fas fa-rupee-sign"></i> ${currentProduct.price}</span>
              </div>
            </div>
          </div>
        `;
        
        productPreview.style.display = 'block';
        msg.textContent = 'Product found! Review details before deleting.';
        msg.className = 'msg success';
        
      } catch (err) {
        productPreview.style.display = 'none';
        msg.textContent = err.message || 'Product not found';
        msg.className = 'msg error';
      }
    });

    // Confirm delete button
    document.getElementById('confirmDelete').addEventListener('click', () => {
      if (!currentProduct) return;
      
      // Show modal
      const modalPreview = document.getElementById('modalPreview');
      modalPreview.innerHTML = `
        <div class="modal-product">
          <h4>${currentProduct.name}</h4>
          <p>ID: ${currentProduct.id}</p>
          <p>Category: ${currentProduct.category}</p>
          <p>Price: â‚¹${currentProduct.price}</p>
        </div>
      `;
      confirmModal.style.display = 'flex';
    });

    // Cancel delete button
    document.getElementById('cancelDelete').addEventListener('click', () => {
      productPreview.style.display = 'none';
      document.getElementById('id').value = '';
      msg.textContent = '';
      msg.className = 'msg';
    });

    // Modal actions
    document.getElementById('finalConfirm').addEventListener('click', async () => {
      if (!currentProduct) return;
      
      try {
        msg.textContent = 'Deleting product...';
        msg.className = 'msg info';
        
        await apiDelete('/api/items/' + encodeURIComponent(currentProduct.id));
        
        msg.textContent = 'Product deleted successfully!';
        msg.className = 'msg success';
        
        // Hide preview and modal
        productPreview.style.display = 'none';
        confirmModal.style.display = 'none';
        document.getElementById('id').value = '';
        
        // Reload products list
        loadProducts();
        
        // Redirect after 2 seconds
        setTimeout(() => {
          location.href = 'home.html';
        }, 2000);
        
      } catch (err) {
        msg.textContent = err.message || 'Delete failed';
        msg.className = 'msg error';
        confirmModal.style.display = 'none';
      }
    });

    document.getElementById('modalCancel').addEventListener('click', () => {
      confirmModal.style.display = 'none';
    });

    // Close modal when clicking outside
    confirmModal.addEventListener('click', (e) => {
      if (e.target === confirmModal) {
        confirmModal.style.display = 'none';
      }
    });

    // Load products on page load
    loadProducts();
  </script>
</body>
</html>